<script setup lang="ts">
import { createApiKey, deleteApiKey, getApiKeys } from '@/api/workspaceApi';
import { useSnackbarStore } from '@/stores/snackbarStore';
import { useWorkspaceStore } from '@/stores/workspaceStore';
import type { ApiKey, CreateApiKeyRequest } from '@/types/api';
import { computed, onMounted, ref } from 'vue';
import { formatDate } from '~/src/utils/date';
import { maskApiKey } from '~/src/utils/stringUtils';

// 加载状态
const loading = ref(false);
const creating = ref(false);
const deleting = ref(false);

// 对话框状态
const createTokenDialog = ref(false);
const deleteTokenDialog = ref(false);
const selectedToken = ref<ApiKey | null>(null);
const createdTokenKey = ref<string>('');

// 新密钥表单
const newToken = ref({
  name: '',
  description: '',
  permissions: [] as string[],
  expiresAt: '',
});

// 表单验证规则
const nameRules = [
  (v: string) => !!v || '密钥名称不能为空',
  (v: string) => v.length >= 3 || '密钥名称至少需要3个字符',
  (v: string) => v.length <= 50 || '密钥名称不能超过50个字符',
];

const descriptionRules = [(v: string) => !v || v.length <= 200 || '描述不能超过200个字符'];

// 权限选项（暂时隐藏）
// const permissionOptions = [
//   { value: 'read', title: '读取权限', description: '查看数据和资源' },
//   { value: 'write', title: '写入权限', description: '创建和修改资源' },
//   { value: 'delete', title: '删除权限', description: '删除资源' },
//   { value: 'admin', title: '管理员权限', description: '完全访问权限' },
// ];

const snackbarStore = useSnackbarStore();
const workspaceStore = useWorkspaceStore();

// 密钥列表
const tokens = ref<ApiKey[]>([]);

// 加载密钥列表
const loadTokens = async () => {
  loading.value = true;
  try {
    const workspaceId = workspaceStore.currentWorkspaceId;
    if (!workspaceId) {
      showError('请先选择工作空间');
      return;
    }
    const apikeys = await getApiKeys(workspaceId);
    tokens.value = apikeys;
  } catch (error) {
    console.error('加载密钥列表失败:', error);
    showError('加载密钥列表时发生错误');
  } finally {
    loading.value = false;
  }
};

// 统计数据
const stats = computed(() => ({
  total: tokens.value.length,
  active: tokens.value.filter(t => t.status === 'active').length,
  expired: tokens.value.filter(t => t.status === 'expired').length,
  totalUsage: tokens.value.length, // API Key类型没有usageCount字段，暂时使用总数
}));

// 创建密钥
const createToken = async () => {
  if (!newToken.value.name || newToken.value.name.length < 3) {
    showError('请输入有效的密钥名称（至少3个字符）');
    return;
  }

  const workspaceId = workspaceStore.currentWorkspaceId;
  if (!workspaceId) {
    showError('请先选择工作空间');
    return;
  }

  creating.value = true;
  try {
    const request: CreateApiKeyRequest = {
      name: newToken.value.name,
      description: newToken.value.description,
      expiresAt: newToken.value.expiresAt
        ? new Date(newToken.value.expiresAt).toISOString()
        : undefined,
    };

    const apiKeyInfo = await createApiKey(workspaceId, request);
    createdTokenKey.value = apiKeyInfo.apiKey || '';

    // 重新加载密钥列表
    await loadTokens();
    createTokenDialog.value = false;
    resetForm();
    showSuccess('密钥创建成功');
  } catch (error) {
    console.error('创建密钥失败:', error);
    showError('创建密钥时发生错误');
  } finally {
    creating.value = false;
  }
};

// 删除密钥
const deleteToken = async () => {
  if (!selectedToken.value) return;

  const workspaceId = workspaceStore.currentWorkspaceId;
  if (!workspaceId) {
    showError('请先选择工作空间');
    return;
  }

  deleting.value = true;
  try {
    await deleteApiKey(workspaceId, selectedToken.value!.id);
    await loadTokens();
    showSuccess('密钥删除成功');
  } catch (error) {
    console.error('删除密钥失败:', error);
    showError('删除密钥时发生错误');
  } finally {
    deleting.value = false;
    deleteTokenDialog.value = false;
    selectedToken.value = null;
  }
};

// 重置表单
const resetForm = () => {
  newToken.value = {
    name: '',
    description: '',
    permissions: ['read'],
    expiresAt: '',
  };
};

// 复制密钥
const copyToken = async (token: ApiKey) => {
  try {
    const keyToCopy = token.apiKey || token.apiKeyPrefix;
    await navigator.clipboard.writeText(keyToCopy);
    showSuccess('密钥已复制到剪贴板');
  } catch (error) {
    console.error('复制失败:', error);
    showError('复制密钥失败');
  }
};

const copyMCPConfig = async (token: ApiKey) => {
  const mcpConfigTemplate = `
{
  "mcpServers": {
    "cerevox-zerocut": {
      "command": "npx",
      "args": [
        "-y",
        "zerocut"
      ],
      "env": {
        "CEREVOX_API_KEY": "${token.apiKey || token.apiKeyPrefix}",
        "ZEROCUT_PROJECT_CWD": "\${workspaceFolder}"
      }
    }
  }
}`;
  try {
    await navigator.clipboard.writeText(mcpConfigTemplate);
    showSuccess('MCP 配置已复制到剪贴板');
  } catch (error) {
    console.error('复制失败:', error);
    showError('复制 MCP 配置失败');
  }
};

// 显示错误提示
const showError = (message: string) => {
  snackbarStore.showErrorMessage(message);
};

// 显示成功提示
const showSuccess = (message: string) => {
  snackbarStore.showSuccessMessage(message);
};

// 组件挂载时加载数据
onMounted(() => {
  loadTokens();
});

// 获取状态颜色
const getStatusColor = (status: string) => {
  switch (status) {
    case 'active':
      return 'success';
    case 'expired':
      return 'error';
    case 'disabled':
      return 'warning';
    default:
      return 'grey';
  }
};
</script>

<template>
  <div class="pa-6">
    <!-- 页面标题 -->
    <div class="d-flex justify-space-between align-center mb-6">
      <div>
        <h1 class="text-h4 font-weight-bold mb-2">密钥管理</h1>
        <p class="text-subtitle-1 text-medium-emphasis">管理您的API访问密钥</p>
      </div>
      <div class="d-flex gap-2">
        <v-btn
          color="primary"
          prepend-icon="mdi-plus"
          @click="createTokenDialog = true"
          :loading="loading"
        >
          创建密钥
        </v-btn>
        <v-btn variant="outlined" prepend-icon="mdi-refresh" @click="loadTokens" :loading="loading">
          刷新
        </v-btn>
      </div>
    </div>

    <!-- 统计卡片 -->
    <v-row class="mb-6">
      <v-col cols="12" sm="6" md="3">
        <v-card class="pa-4 text-center" elevation="2">
          <v-icon size="48" color="primary" class="mb-2"> mdi-key-outline </v-icon>
          <div class="text-h4 font-weight-bold mb-1">
            {{ stats.total }}
          </div>
          <div class="text-subtitle-2 text-medium-emphasis">总密钥数</div>
        </v-card>
      </v-col>

      <v-col cols="12" sm="6" md="3">
        <v-card class="pa-4 text-center" elevation="2">
          <v-icon size="48" color="success" class="mb-2"> mdi-check-circle-outline </v-icon>
          <div class="text-h4 font-weight-bold mb-1">
            {{ stats.active }}
          </div>
          <div class="text-subtitle-2 text-medium-emphasis">活跃密钥</div>
        </v-card>
      </v-col>

      <v-col cols="12" sm="6" md="3">
        <v-card class="pa-4 text-center" elevation="2">
          <v-icon size="48" color="error" class="mb-2"> mdi-clock-alert-outline </v-icon>
          <div class="text-h4 font-weight-bold mb-1">
            {{ stats.expired }}
          </div>
          <div class="text-subtitle-2 text-medium-emphasis">已过期</div>
        </v-card>
      </v-col>

      <v-col cols="12" sm="6" md="3">
        <v-card class="pa-4 text-center" elevation="2">
          <v-icon size="48" color="info" class="mb-2"> mdi-chart-bar </v-icon>
          <div class="text-h4 font-weight-bold mb-1">
            {{ stats.totalUsage.toLocaleString() }}
          </div>
          <div class="text-subtitle-2 text-medium-emphasis">总调用次数</div>
        </v-card>
      </v-col>
    </v-row>

    <!-- 密钥列表 -->
    <v-card elevation="2">
      <v-card-title class="d-flex align-center">
        <v-icon class="mr-2">mdi-format-list-bulleted</v-icon>
        密钥列表
      </v-card-title>

      <v-data-table
        :headers="[
          { title: '名称', key: 'name', sortable: true },
          { title: '描述', key: 'description', sortable: false },
          { title: '密钥', key: 'key', sortable: false, width: '240px' },
          { title: '创建者', key: 'creator', sortable: true },
          { title: '创建时间', key: 'createdAt', sortable: true },
          { title: '过期时间', key: 'expiresAt', sortable: true },
          { title: '状态', key: 'status', sortable: true },
          // { title: '操作', key: 'actions', sortable: false },
          // { title: '最后使用', key: 'lastUsedAt', sortable: true },
        ]"
        :items="tokens"
        item-value="id"
        class="elevation-0"
        :loading="loading"
        :items-per-page="-1"
        hide-default-footer
      >
        <template #item.key="{ item }">
          <div class="d-flex align-center">
            <code class="text-caption mr-2">{{ maskApiKey(item.apiKeyPrefix) }}</code>
            <v-btn icon="mdi-key" size="x-small" variant="text" @click="copyToken(item)"></v-btn>
            <v-btn
              icon="mdi-robot"
              size="x-small"
              variant="text"
              tooltip="复制MCP配置"
              @click="copyMCPConfig(item)"
              >MCP</v-btn
            >
          </div>
        </template>

        <template #item.creator="{ item }">
          <div class="d-flex align-center">
            <v-avatar size="24" class="mr-2">
              <v-icon icon="mdi-account" size="16"></v-icon>
            </v-avatar>
            <span class="text-body-2">
              {{ item.creator?.username || item.creator?.email || '未知用户' }}
            </span>
          </div>
        </template>

        <template #item.createdAt="{ item }">
          {{ formatDate(item.createdAt) }}
        </template>

        <template #item.lastUsedAt="{ item }">
          {{ item.lastUsedAt || '从未使用' }}
        </template>

        <template #item.expiresAt="{ item }">
          {{ item.expiresAt ? formatDate(item.expiresAt) : '永不过期' }}
        </template>

        <template #item.status="{ item }">
          <v-chip :color="getStatusColor(item.status)" size="small" variant="tonal">
            {{
              item.status === 'active' ? '活跃' : item.status === 'expired' ? '已过期' : '已禁用'
            }}
          </v-chip>
        </template>
      </v-data-table>
    </v-card>

    <!-- 创建密钥对话框 -->
    <v-dialog v-model="createTokenDialog" max-width="600">
      <v-card>
        <v-card-title class="d-flex align-center">
          <v-icon class="mr-2">mdi-plus</v-icon>
          创建新密钥
        </v-card-title>

        <v-card-text>
          <v-form>
            <v-text-field
              v-model="newToken.name"
              label="密钥名称"
              placeholder="输入密钥名称"
              :rules="nameRules"
              required
              class="mb-4"
            ></v-text-field>

            <v-textarea
              v-model="newToken.description"
              label="描述"
              placeholder="输入密钥用途描述"
              :rules="descriptionRules"
              rows="3"
              class="mb-4"
            ></v-textarea>

            <!-- 权限选择暂时隐藏 -->
            <!-- <v-select
              v-model="newToken.permissions"
              :items="permissionOptions"
              item-title="title"
              item-value="value"
              label="权限"
              multiple
              chips
              class="mb-4"
            >
              <template #item="{ props, item }">
                <v-list-item v-bind="props">
                  <template #subtitle>
                    {{ item.raw.description }}
                  </template>
                </v-list-item>
              </template>
            </v-select> -->

            <v-text-field
              v-model="newToken.expiresAt"
              label="过期时间（可选）"
              type="date"
              hint="留空表示永不过期"
              persistent-hint
            ></v-text-field>
          </v-form>
        </v-card-text>

        <v-card-actions>
          <v-spacer></v-spacer>
          <v-btn
            variant="text"
            @click="
              createTokenDialog = false;
              resetForm();
            "
          >
            取消
          </v-btn>
          <v-btn
            color="primary"
            variant="flat"
            @click="createToken"
            :disabled="!newToken.name || creating"
            :loading="creating"
          >
            创建
          </v-btn>
        </v-card-actions>
      </v-card>
    </v-dialog>

    <!-- 删除确认对话框 -->
    <v-dialog v-model="deleteTokenDialog" max-width="400">
      <v-card>
        <v-card-title class="d-flex align-center text-error">
          <v-icon class="mr-2">mdi-alert</v-icon>
          确认删除
        </v-card-title>

        <v-card-text> 确定要删除密钥 "{{ selectedToken?.name }}" 吗？此操作不可撤销。 </v-card-text>

        <v-card-actions>
          <v-spacer></v-spacer>
          <v-btn
            variant="text"
            @click="
              deleteTokenDialog = false;
              selectedToken = null;
            "
          >
            取消
          </v-btn>
          <v-btn color="error" variant="flat" @click="deleteToken" :loading="deleting">
            删除
          </v-btn>
        </v-card-actions>
      </v-card>
    </v-dialog>
  </div>
</template>

<style scoped>
.v-card {
  transition: all 0.3s ease;
}

.v-card:hover {
  transform: translateY(-2px);
}

code {
  background-color: rgba(0, 0, 0, 0.05);
  padding: 2px 4px;
  border-radius: 4px;
  font-family: 'Courier New', monospace;
}
</style>
